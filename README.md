# Pararun.exe
Windows用の、プログラム(バッチファイル）群を並列実行するコマンド。  
Batch file parallel execution command for Windows.

スレッドを使って指定ディレクトリにあるプログラムファイルを並列実行するコマンドです。  
対象プログラムの種類は "*.bat"、"*.cmd"、"*.exe" です。

指定ディレクトリにある実行ファイルパスはキュー(FIFO)に格納されます。
生成されたスレッド群がこのキューから実行ファイルパスを取り出して実行します。スレッドは並列に実行されるので、プログラムも並列実行されることになります。

全てのスレッドがキューから実行ファイルパスを読み出せなくなったら終了となります。 

# Pararun.exeのコンパイル
make.batを用意したので、Visual Studioが無くても.NET Frameworkを導入していればコンパイルできます。たぶん。


# オプション等説明
    H:\JOB>pararun
    pararun [-ut] [-nr] -qs count folder [folder ...] [-qf count folder [folder ...]] [-qh count folder [folder ...]]
    
        -ut : Use "Task Class"
        -nr : Not reuse free threads.
        -qs : Use "s" queue.
        -qf : Use "f" queue.
        -qh : Use "h" queue.
      count : Number of the used thread.
     folder : Batch job stock folder.
    
    H:\JOB>

"-ut" は.NETのTASKクラスを使ったスレッド処理を指定します。通常は指定する必要はありません。こちらの方が速いという環境があったので用意しました。

"-nr" は各キューの処理で使用したスレッドを他キューの処理で使用させたくない場合に指定します。

"-qs"、"-qf"、"-qh" でそれぞれ sキュー、fキュー、hキューについてスレッド数(並列数)と処理対象ディレクトリを指定します。  
"-qs"、"-qf"、"-qh"が指定されなかった場合は、"-qs 4" が仮定されsキューを4スレッド(4並列)で処理することになります。

## 単一キューでの実行
sキューはデフォルトのキューで必ず使用されます。オプションが全く指定されていない場合、sキューに実行ファイルのパスが格納され4スレッドで実行が行われます。

例えば以下の指定
    
    pararun .\job1 .\job2 .\job3
    
は、

* ディレクトリ .\job1、.\job2、.\job3 にある *.CMD、*.BAT、*.EXE、を sキュー に格納
* sキューの実行ファイルを4スレッド(4並列)で実行

を意味します。指定するディレクトリ名の最後に‟￥”をつけないでください。  
明示的にsキュー処理用のスレッド数を指定する場合、例えば、
    
    pararun -qs 6 .\job1 .\job2 .\job3`
    
の指定は、

* ディレクトリ .\job1、.\job2、.\job2 にある *.CMD、*.BAT、*.EXE、を sキュー に格納
* sキューの実行ファイルを6スレッド(6並列)で実行

を意味します。

## 複数キューでの実行

キューは3つまで利用できます。例えば、
    
    pararun .\job2 .\job1 -qf 3 .\job3 -qh 1 .\job4
    
の指定は、

* ディレクトリ .\job2、.\job1 にある *.CMD、*.BAT、*.EXE、を sキュー に格納
* ディレクトリ .\job3 にある *.CMD、*.BAT、*.EXE、を fキュー に格納
* ディレクトリ .\job4 にある *.CMD、*.BAT、*.EXE、を hキュー に格納
* sキューを4スレッド(4並列)で実行
* fキューを3スレッド(3並列)で実行
* hキューを1スレッド(1並列)で実行

を意味しますし、以下の指定、
    
    pararun -qs 8 .\job2 .\job1 -qf 3 .\job3 -qh 1 .\job4
    
の場合は、

* ディレクトリ .\job2、.\job1 にある *.CMD、*.BAT、*.EXE、を sキュー に格納
* ディレクトリ .\job3 にある *.CMD、*.BAT、*.EXE、を fキュー に格納
* ディレクトリ .\job4 にある *.CMD、*.BAT、*.EXE、を hキュー に格納
* sキューを8スレッド(8並列)で実行
* fキューを3スレッド(3並列)で実行
* hキューを1スレッド(1並列)で実行

を意味します。

## スレッドの再使用
"-nr" が指定されていなければ、各キューで使ったスレッド他キューの処理に使用されます。

* sキューの内容が全て実行されたのち、
 * まだfキューに処理されていない実行ファイルがあると、sキューで使っていたスレッドをfキューの処理に使用します。
 * まだhキューに処理されていない実行ファイルがあると、sキューで使っていたスレッドをhキューの処理に使用します。

* fキューの内容が全て実行されたのち、
 * まだsキューに処理されていない実行ファイルがあると、fキューで使っていたスレッドをsキューの処理に使用します。
 * まだhキューに処理されていない実行ファイルがあると、fキューで使っていたスレッドをhキューの処理に使用します。

* hキューの内容が全て実行されたのち、
 * まだsキューに処理されていない実行ファイルがあると、hキューで使っていたスレッドをsキューの処理に使用します。
 * まだfキューに処理されていない実行ファイルがあると、hキューで使っていたスレッドをfキューの処理に使用します。

# 実行例
以下は実行例です。   
ディレクトリ H:\JOBにPARARUN.EXEがあり、H:\JOB\job1、H:\JOB\job2、H:\JOB\job3、のディレクトリがあります。 

時刻はローカルタイムです。タイムゾーンが日本に設定されているOSで実行したのであれば、2016/06/22 5:30:32 は素直に日本時間の 2016/06/22 5:30:32 になります。  
s0～1がsキュー、f0～1がfキュー、h0がhキューの処理に使われているスレッドのスレッド名です。  
各スレッドで実行中の処理時間が5分以上かかっている場合、‟LongRun”のメッセージが出ます。  
処理終了時のリターンコードを rcd=xx の形でログに出力しています。

全部のスレッドで‟Queue is empty.”のメッセージが出ると全ての実行ファイルが実行されたことになります。
    
    H:\JOB>pararun -qs 2 .\job1 -qf 2 .\job2 -qh 1 .\job3
    
    2016/06/22 5:30:32,----, Thread reuse mode: True
    2016/06/22 5:30:32,----, Use Task Class: False
    2016/06/22 5:30:32,----, s queue is use 2 threads
    2016/06/22 5:30:32,----, f queue is use 2 threads
    2016/06/22 5:30:32,----, h queue is use 1 threads
    2016/06/22 5:30:32,----, total 5 threads use, 9 jobs enqueued.
    2016/06/22 5:30:32,----, Start    threads
    2016/06/22 5:30:32,  s0, Start    .\job1\a1.bat
    2016/06/22 5:30:32,  s1, Start    .\job1\b1.bat
    2016/06/22 5:30:32,  f1, Start    .\job2\a2.bat
    2016/06/22 5:30:32,  h0, Start    .\job3\a3.bat
    2016/06/22 5:30:32,  f0, Start    .\job2\b2.bat
    2016/06/22 5:30:35,  f0, Finish   .\job2\b2.bat, 00:00:03.0739841, rcd=13
    2016/06/22 5:30:35,  f0, Start    .\job2\c2.bat
    2016/06/22 5:30:35,  f1, Finish   .\job2\a2.bat, 00:00:03.0994884, rcd=0
    2016/06/22 5:30:35,  f1, Start    .\job1\c1.bat
    2016/06/22 5:30:37,  s0, Finish   .\job1\a1.bat, 00:00:05.1208972, rcd=0
    2016/06/22 5:30:37,  s0, Start    .\job3\b3.bat
    2016/06/22 5:30:38,  f0, Finish   .\job2\c2.bat, 00:00:03.0000954, rcd=0
    2016/06/22 5:30:38,  f0, Start    .\job3\c3.bat
    2016/06/22 5:30:40,  f1, Finish   .\job1\c1.bat, 00:00:04.9450942, rcd=0
    2016/06/22 5:30:40,  f1, Queue is empty.
    2016/06/22 5:31:02,  s1, Finish   .\job1\b1.bat, 00:00:30.1207724, rcd=0
    2016/06/22 5:31:02,  s1, Queue is empty.
    2016/06/22 5:31:22,  h0, Finish   .\job3\a3.bat, 00:00:50.0874377, rcd=0
    2016/06/22 5:31:22,  h0, Queue is empty.
    2016/06/22 5:31:33,  f0, Finish   .\job3\c3.bat, 00:00:55.0596714, rcd=0
    2016/06/22 5:31:33,  f0, Queue is empty.
    2016/06/22 5:35:37,  s0, LongRun  .\job3\b3.bat
    2016/06/22 5:36:07,  s0, Finish   .\job3\b3.bat, 00:05:29.9256878, rcd=0
    2016/06/22 5:36:07,  s0, Queue is empty.
    2016/06/22 5:36:07,----, End      threads, 00:05:35.1250946
    2016/06/22 5:36:07,----, Retcode    0 :     8 jobs.
    2016/06/22 5:36:07,----, Retcode   13 :     1 jobs.
    H:\JOB>
    
